<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ギャンブル・オフ - 新しい人生の記録</title>
    <style>
        :root {
            --primary: #e91e63;
            --secondary: #fbc02d;
            --bg: #f5f5f5;
            --card-bg: #ffffff;
            --text: #333;
            --success: #4caf50;
            --danger: #d32f2f;
        }

        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
        }
        h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--primary);
        }
        .stats-top {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }
        .streak-display, .total-display {
            font-size: 1.8rem;
            font-weight: bold;
        }
        .streak-label {
            font-size: 0.8rem;
            color: #777;
        }

        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* 助言エリア */
        .advice-section {
            background: linear-gradient(135deg, #e91e63 0%, #ff80ab 100%);
            color: white;
            text-align: center;
        }
        .advice-text {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
            min-height: 3em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .refresh-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            cursor: pointer;
        }

        /* アクション */
        .checkin-btn {
            width: 100%;
            padding: 15px;
            font-size: 1.2rem;
            background-color: var(--success);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }
        .checkin-btn:disabled { background-color: #ccc; }

        /* カレンダー */
        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .nav-btn {
            background: #eee;
            border: none;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .day {
            padding: 10px 0;
            border-radius: 5px;
            background: #eee;
            text-align: center;
            font-size: 0.9rem;
            cursor: pointer;
            transition: 0.2s;
        }
        .day.checked {
            background: var(--success);
            color: white;
            font-weight: bold;
        }
        .day.today { border: 2px solid var(--primary); }

        /* 統計データ */
        .info-card {
            font-size: 0.85rem;
            border-left: 5px solid var(--danger);
        }
        .info-title {
            color: var(--danger);
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }

        /* 外部リンク */
        .ga-link {
            display: block;
            text-align: center;
            background: #2196f3;
            color: white;
            text-decoration: none;
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
            font-weight: bold;
        }

        .settings-details { display: none; margin-top: 10px; }
        .settings-toggle { text-align: center; color: #777; font-size: 0.8rem; cursor: pointer; text-decoration: underline; }
        input { width: 80px; padding: 5px; margin: 5px; }

        .confetti { position: fixed; width: 10px; height: 10px; animation: fall linear forwards; z-index: 9999; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Gamble Off Tracker</h1>
        <div class="stats-top">
            <div>
                <div class="streak-label">現在の継続</div>
                <div class="streak-display"><span id="streakCount">0</span> 日</div>
            </div>
            <div>
                <div class="streak-label">累計達成</div>
                <div class="total-display"><span id="totalCount">0</span> 日</div>
            </div>
        </div>
    </header>

    <div class="card advice-section">
        <div class="advice-text" id="adviceText">...</div>
        <button class="refresh-btn" onclick="updateAdvice()">別の助言を見る</button>
    </div>

    <!-- アクション -->
    <div class="card" style="text-align: center;">
        <p style="margin-top:0;">今日はギャンブルを控えられましたか？</p>
        <button class="checkin-btn" id="checkinBtn" onclick="checkInToday()">今日も一日クリア！</button>
        <p id="cheerMessage" style="color: var(--primary); font-weight: bold; margin-top: 10px; font-size: 0.9rem;"></p>
    </div>

    <!-- カレンダー（修正可能） -->
    <div class="card">
        <div class="calendar-nav">
            <button class="nav-btn" onclick="changeMonth(-1)">◀ 前月</button>
            <div id="calendarHeader" style="font-weight: bold;"></div>
            <button class="nav-btn" onclick="changeMonth(1)">次月 ▶</button>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
        <p style="font-size: 0.7rem; color: #777; margin-top: 10px; text-align: center;">※日付をタップすると記録を修正できます</p>
    </div>

    <!-- 成果統計 -->
    <div class="card">
        <div style="display: flex; justify-content: space-around; text-align: center;">
            <div>
                <div style="font-size: 0.8rem;">守ったお金</div>
                <div id="moneySaved" style="font-weight: bold; color: #1565c0;">¥0</div>
            </div>
            <div>
                <div style="font-size: 0.8rem;">取り戻した時間</div>
                <div id="timeSaved" style="font-weight: bold; color: #1565c0;">0時間</div>
            </div>
        </div>
        <div class="settings-toggle" onclick="toggleSettings()" style="margin-top:15px;">設定変更（平均使用額など）</div>
        <div class="settings-details" id="settingsArea">
            <label>1回の平均額: <input type="number" id="avgMoney" value="30000">円</label><br>
            <label>1回の平均時間: <input type="number" id="avgTime" value="4">時間</label>
            <button onclick="saveSettings()">保存</button>
        </div>
    </div>

    <!-- 社会的データ・外部リンク -->
    <div class="card info-card">
        <div class="info-title">⚠️ 厳しい現実を知る</div>
        <p style="margin: 5px 0;">
            警察庁「令和5年中における自殺の概要」によると、経済・生活問題（借金・ギャンブル等）を原因の一つとする自殺者は年間<b>4,000人以上</b>にのぼります。
        </p>
        <p style="margin: 5px 0; font-size: 0.8rem; color: #555;">
            ギャンブル依存は意志の問題ではなく、適切な支援が必要な「病気」です。一人で抱え込まないでください。
        </p>
        <a href="http://www.gajapan.jp/" target="_blank" class="ga-link">GA (ギャンブラーズ・アノニマス) 公式HP</a>
    </div>

    <div style="text-align: center; margin-bottom: 40px;">
        <button onclick="showSOS()" style="background:none; border:none; color:#777; text-decoration: underline; cursor:pointer;">緊急メッセージを表示</button>
    </div>
</div>

<script>
    let appData = {
        history: [], // 'YYYY-MM-DD'
        avgMoney: 30000,
        avgTime: 4
    };

    let currentViewDate = new Date();

    const adviceList = [
        "ギャンブル障害は脳の回路の問題です。意志の弱さではありません。",
        "「今日一日だけ」ギャンブルをしない。その積み重ねが未来です。",
        "渇望（やりたい気持ち）は波。数分耐えれば必ず引いていきます。",
        "勝った記憶は「脳の罠」。負けた時の絶望感を思い出してください。",
        "財布には必要最低限のお金だけを入れましょう。",
        "「取り返そう」とするのが一番の罠です。負けを認めることが回復への一歩。",
        "暇な時間は危険です。散歩や読書、予定を詰めましょう。",
        "嘘をつく必要のない生活は、とても心が軽くなります。",
        "スリップ（再発）しても自分を責めすぎず、また今日から再開しましょう。"
    ];

    function init() {
        const stored = localStorage.getItem('gamble_off_data_v2');
        if (stored) appData = JSON.parse(stored);
        
        document.getElementById('avgMoney').value = appData.avgMoney;
        document.getElementById('avgTime').value = appData.avgTime;

        renderAll();
        updateAdvice();
    }

    function renderAll() {
        saveData();
        renderStats();
        renderCalendar();
        checkButtonState();
    }

    function saveData() {
        localStorage.setItem('gamble_off_data_v2', JSON.stringify(appData));
    }

    function getTodayString() {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    }

    function renderStats() {
        const total = appData.history.length;
        document.getElementById('totalCount').innerText = total;

        // 継続日数の計算（今日から遡って何日連続か）
        let streak = 0;
        let checkDate = new Date();
        while (true) {
            const dateStr = `${checkDate.getFullYear()}-${String(checkDate.getMonth()+1).padStart(2, '0')}-${String(checkDate.getDate()).padStart(2, '0')}`;
            if (appData.history.includes(dateStr)) {
                streak++;
                checkDate.setDate(checkDate.getDate() - 1);
            } else {
                // 今日がまだ未達成の場合は昨日の分から数えるが、今日は継続中として扱う
                if (streak === 0 && dateStr === getTodayString()) {
                    checkDate.setDate(checkDate.getDate() - 1);
                    continue;
                }
                break;
            }
        }
        document.getElementById('streakCount').innerText = streak;
        document.getElementById('moneySaved').innerText = `¥${(total * appData.avgMoney).toLocaleString()}`;
        document.getElementById('timeSaved').innerText = `${total * appData.avgTime}時間`;
    }

    function renderCalendar() {
        const year = currentViewDate.getFullYear();
        const month = currentViewDate.getMonth();
        document.getElementById('calendarHeader').innerText = `${year}年 ${month + 1}月`;

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';

        // 空白
        for (let i = 0; i < firstDay.getDay(); i++) {
            grid.appendChild(document.createElement('div'));
        }

        const todayStr = getTodayString();
        for (let d = 1; d <= lastDay.getDate(); d++) {
            const dateStr = `${year}-${String(month+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const div = document.createElement('div');
            div.className = 'day';
            if (dateStr === todayStr) div.classList.add('today');
            if (appData.history.includes(dateStr)) div.classList.add('checked');
            
            div.innerText = d;
            div.onclick = () => toggleDate(dateStr);
            grid.appendChild(div);
        }
    }

    function toggleDate(dateStr) {
        const index = appData.history.indexOf(dateStr);
        if (index > -1) {
            appData.history.splice(index, 1);
        } else {
            appData.history.push(dateStr);
            if (dateStr === getTodayString()) triggerConfetti();
        }
        renderAll();
    }

    function changeMonth(diff) {
        currentViewDate.setMonth(currentViewDate.getMonth() + diff);
        renderCalendar();
    }

    function checkInToday() {
        const today = getTodayString();
        if (!appData.history.includes(today)) {
            toggleDate(today);
            document.getElementById('cheerMessage').innerText = "ナイス！今日も一歩前進しました！";
        }
    }

    function checkButtonState() {
        const btn = document.getElementById('checkinBtn');
        if (appData.history.includes(getTodayString())) {
            btn.innerText = "本日は記録済み ✅";
            btn.disabled = true;
        } else {
            btn.innerText = "今日も一日クリア！";
            btn.disabled = false;
        }
    }

    function updateAdvice() {
        document.getElementById('adviceText').innerText = adviceList[Math.floor(Math.random() * adviceList.length)];
    }

    function saveSettings() {
        appData.avgMoney = parseInt(document.getElementById('avgMoney').value) || 0;
        appData.avgTime = parseInt(document.getElementById('avgTime').value) || 0;
        renderAll();
        toggleSettings();
        alert("設定を保存しました。");
    }

    function toggleSettings() {
        const area = document.getElementById('settingsArea');
        area.style.display = area.style.display === 'block' ? 'none' : 'block';
    }

    function showSOS() {
        alert("【緊急メッセージ】\n1. その場から離れてください。\n2. 深呼吸を10回してください。\n3. 「今日使おうとしているお金」で買える、大切な人へのプレゼントを想像してください。\n\nあなたは一人ではありません。GAのリンクも活用してください。");
    }

    function triggerConfetti() {
        const colors = ['#e91e63', '#fbc02d', '#2196f3', '#4caf50'];
        for (let i = 0; i < 40; i++) {
            const c = document.createElement('div');
            c.className = 'confetti';
            c.style.left = Math.random() * 100 + 'vw';
            c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            c.style.animationDuration = (Math.random() * 2 + 1) + 's';
            c.style.width = c.style.height = (Math.random() * 10 + 5) + 'px';
            document.body.appendChild(c);
            setTimeout(() => c.remove(), 3000);
        }
    }

    init();
</script>

</body>

</html>
